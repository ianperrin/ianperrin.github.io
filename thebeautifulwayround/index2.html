<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <!-- LeafletJS css -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.4/dist/leaflet.css"
      integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA=="
      crossorigin=""/>
    <!-- LeafletJS JavaScript -->
    <script src="https://unpkg.com/leaflet@1.3.4/dist/leaflet.js" integrity="sha512-nMMmRyTVoLYqjP9hrbed9S+FzjZHW5gY1TWCHA5ckwXZBadntCNs8kEqAWdrb9O7rxbCaA4lKTIWjDXZxflOcA==" crossorigin=""></script>
    <!-- Bootstrap core JavaScript  -->
    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    <style type="text/css">
    html, body, #map {
        padding: 0;
        margin: 0; 
        height: 100vh;
    }
    </style>
</head>

<body>
    <div id="map"></div>

    <script type="text/javascript">

L.AnimatedMarker = L.Marker.extend({
  options: {
    // meters
    distance: 200,
    // ms
    interval: 1000,
    // animate on add?
    autoStart: true,
    // callback onend
    onEnd: function(){},
    clickable: false
  },

  initialize: function (latlngs, options) {
    this.setLine(latlngs);
    L.Marker.prototype.initialize.call(this, latlngs[0], options);
  },

  // Breaks the line up into tiny chunks (see options) ONLY if CSS3 animations
  // are not supported.
  _chunk: function(latlngs) {
    var i,
        len = latlngs.length,
        chunkedLatLngs = [];

    for (i=1;i<len;i++) {
      var cur = latlngs[i-1],
          next = latlngs[i],
          dist = cur.distanceTo(next),
          factor = this.options.distance / dist,
          dLat = factor * (next.lat - cur.lat),
          dLng = factor * (next.lng - cur.lng);

      if (dist > this.options.distance) {
        while (dist > this.options.distance) {
          cur = new L.LatLng(cur.lat + dLat, cur.lng + dLng);
          dist = cur.distanceTo(next);
          chunkedLatLngs.push(cur);
        }
      } else {
        chunkedLatLngs.push(cur);
      }
    }
    chunkedLatLngs.push(latlngs[len-1]);

    return chunkedLatLngs;
  },

  onAdd: function (map) {
    L.Marker.prototype.onAdd.call(this, map);

    // Start animating when added to the map
    if (this.options.autoStart) {
      this.start();
    }
  },

  animate: function() {
    var self = this,
        len = this._latlngs.length,
        speed = this.options.interval;

    // Normalize the transition speed from vertex to vertex
    if (this._i < len && this._i > 0) {
      speed = this._latlngs[this._i-1].distanceTo(this._latlngs[this._i]) / this.options.distance * this.options.interval;
    }

    // Only if CSS3 transitions are supported
    if (L.DomUtil.TRANSITION) {
      if (this._icon) { this._icon.style[L.DomUtil.TRANSITION] = ('all ' + speed + 'ms linear'); }
      if (this._shadow) { this._shadow.style[L.DomUtil.TRANSITION] = 'all ' + speed + 'ms linear'; }
    }

    // Move to the next vertex
    this.setLatLng(this._latlngs[this._i]);
    this._i++;

    // Queue up the animation to the next next vertex
    this._tid = setTimeout(function(){
      if (self._i === len) {
        self.options.onEnd.apply(self, Array.prototype.slice.call(arguments));
      } else {
        self.animate();
      }
    }, speed);
  },

  // Start the animation
  start: function() {
    this.animate();
  },

  // Stop the animation in place
  stop: function() {
    if (this._tid) {
      clearTimeout(this._tid);
    }
  },

  restart: function(latlngs){
    this.initialize(latlngs);
    // Don't show CSS transition back to initial position
    this._icon.style[L.DomUtil.TRANSITION] = ('all ' + 0 + 'ms linear')
    this._shadow.style[L.DomUtil.TRANSITION] = ('all ' + 0 + 'ms linear')
    // Reset marker to initial position
    this.setLatLng(this._latlngs[0]);
    var that = this;
    setTimeout(function(){
    that.start();
    }, 200)
  },

  setLine: function(latlngs){
    if (L.DomUtil.TRANSITION) {
      // No need to to check up the line if we can animate using CSS3
      this._latlngs = latlngs;
    } else {
      // Chunk up the lines into options.distance bits
      this._latlngs = this._chunk(latlngs);
      this.options.distance = 10;
      this.options.interval = 30;
    }
    this._i = 0;
  }

});

L.animatedMarker = function (latlngs, options) {
  return new L.AnimatedMarker(latlngs, options);
};


        // Base layers
        var attribution = '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a>'
        var osmTiles = L.tileLayer(
            'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: attribution
        });
        var stamenTerrainTiles = L.tileLayer(
            'https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.{ext}', {
            attribution: '<a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>',
            subdomains: 'abcd',
            minZoom: 0,
            maxZoom: 18,
            ext: 'png'
        });
        var map = L.map('map')
            .addLayer(stamenTerrainTiles);
            map.on('overlayadd', onOverlayAdd);
        
        function onOverlayAdd(e){
            if(e.name === "Animation")
                animatedMarker.restart(latLngs);
        }

        var files = ["data/part1.min.geojson", "data/part2.min.geojson"]
        var data = [
            {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"LineString","coordinates":[[-2.558366982266307,51.55008601024747,80.89],[-2.558741988614202,51.549993976950645,81.37],[-2.562538990750909,51.54894397594035,86.18],[-2.566594993695617,51.54770202934742,91.94],[-2.570030987262726,51.546471985056996,91.94],[-2.574674980714917,51.54481798410416,90.98],[-2.578272996470332,51.54352901503444,91.46],[-2.581596001982689,51.54235202819109,90.5],[-2.585566006600857,51.54056802392006,89.54],[-2.58757003583014,51.5388769749552,89.06],[-2.589425034821033,51.53674998320639,90.5],[-2.592015964910388,51.534525007009506,90.02],[-2.595061026513577,51.53266699053347,82.81],[-2.597814984619617,51.53143996372819,77.04],[-2.602611025795341,51.529965000227094,69.35],[-2.606074009090662,51.52930601499975,69.35],[-4.465160015970469,50.94854498282075,216.91],[-4.463806003332138,50.947286020964384,206.34],[-4.463701983913779,50.94714696519077,205.38],[-4.463588995859027,50.94699701294303,204.42],[-4.463475001975894,50.94684395939112,203.46],[-4.463397972285748,50.94667104072869,202.49],[-4.463314991444349,50.94648001715541,200.09],[-4.462923975661397,50.944860968738794,187.11],[-4.462869996204972,50.943464040756226,181.83],[-4.462944008409977,50.94323697499931,181.83],[-4.463617997244,50.940928012132645,194.32],[-4.464058969169855,50.93890696763992,208.26],[-4.464324004948139,50.93791496939957,209.22],[-4.464312018826604,50.9377889893949,209.22],[-4.464526008814573,50.93774599023163,210.19],[-4.46473496966064,50.937682036310434,210.19],[-4.464960023760796,50.9376129694283,209.22],[-4.465215001255274,50.937535017728806,208.74],[-4.467594036832452,50.93690603971481,218.84],[-4.470547987148166,50.93621696345508,220.76],[-4.470691988244653,50.93612903729081,220.76],[-4.47081402875483,50.936006996780634,221.24],[-4.47089902125299,50.935922004282475,220.76],[-4.47090296074748,50.93578496016562,219.8],[-4.470906984061003,50.9356479998678,218.84],[-4.470911007374525,50.935497963801026,220.28],[-4.470917964354157,50.93418602831662,217.4],[-4.471077974885702,50.932269003242254,220.76],[-4.471464967355132,50.93082496896386,221.24],[-4.47141501121223,50.9304310195148,219.8],[-4.471300011500716,50.93026597984135,220.28],[-4.471174031496048,50.93008602038026,220.76],[-4.471043022349477,50.9298990201205,221.72],[-4.470908995717764,50.92970799654722,221.72],[-4.47079299017787,50.929519990459085,222.2],[-4.47072702459991,50.92935604043305,223.64],[-4.470734987407923,50.92912998050451,223.64],[-4.470742028206587,50.92891003936529,224.12],[-4.47075099684298,50.92867702245712,223.16],[-4.470838000997901,50.926874997094274,217.4],[-4.47064203210175,50.92573002912104,215.47],[-4.470804976299405,50.92534898780286,216.91],[-4.47096599265933,50.92515201307833,217.4],[-4.472607001662254,50.923589961603284,218.84],[-4.475234979763627,50.92155399732292,214.99],[-4.476867020130157,50.919937966391444,209.22],[-4.478501994162798,50.917400009930134,215.47],[-4.480147026479244,50.91534703038633,222.68],[-4.481769008561969,50.9133040253073,227.01],[-4.482612982392311,50.911819003522396,223.64],[-4.482671990990639,50.91161901131272,221.72],[-4.483204996213317,50.9103199839592,215.95],[-4.484389023855329,50.907520009204745,203.46],[-4.484473010525107,50.90542503632605,197.21],[-4.484188025817275,50.90298196300864,191.92],[-4.482993017882109,50.9008620120585,183.75],[-4.885703986510634,50.556687992066145,41.95],[-4.885891992598772,50.55660903453827,42.92],[-4.887699969112873,50.555915012955666,51.09],[-4.889051970094442,50.55527203716338,56.86],[-4.890628019347787,50.55477197282016,63.1],[-4.891557991504669,50.55448296479881,63.58],[-4.891620017588139,50.55444499477744,64.55],[-4.891681037843227,50.554407024756074,64.55],[-4.891758989542723,50.55440098978579,64.07],[-4.891823027282953,50.55439696647227,64.55],[-4.89194699563086,50.554390009492636,64.07],[-4.893461018800735,50.55407300591469,65.99],[-4.895841982215643,50.55328804068267,66.47],[-4.896873962134123,50.552844973281026,61.66],[-4.898443976417184,50.55208196863532,56.86],[-4.900586977601051,50.55130496621132,53.49],[-4.900773977860808,50.55121201090515,53.01],[-4.900945974513888,50.55109298788011,53.01],[-4.90112098865211,50.550971031188965,53.01],[-4.902413981035352,50.550135020166636,53.01],[-4.904168983921409,50.5493130069226,52.53],[-4.904556982219219,50.549060963094234,52.53],[-4.90505201742053,50.54868696257472,50.13],[-4.90509401075542,50.54865603335202,49.16],[-4.905125023797154,50.548631977289915,49.16]]},
                "properties":{"name":"The Beautiful Way Round - Part 1","stroke":"#4040ff","stroke-opacity":1,"stroke-width":4}}]},
            {"type":"FeatureCollection","features":[{"type":"Feature","geometry":{"type":"LineString","coordinates":[[-4.904748005792499,50.54891696199775,47.24],[-4.906378034502268,50.547409979626536,50.61],[-4.90767496638,50.54587198421359,46.28],[-4.908205037936568,50.545452972874045,43.4],[-4.908566968515515,50.54533503949642,40.03],[-4.908818006515503,50.5452929623425,38.59],[-4.909068960696459,50.54524996317923,39.07],[-4.910642998293042,50.54511400870979,38.59],[-4.91149895824492,50.545086013153195,34.74],[-4.91171495988965,50.545066986232996,33.78],[-4.91192702203989,50.5450479593128,32.82],[-4.912146041169763,50.545020969584584,30.42],[-4.912352990359068,50.54499498568475,30.42],[-4.91493402980268,50.544484024867415,25.13],[-4.915589997544885,50.54434798657894,23.69],[-4.917509034276009,50.54394297301769,22.25],[-4.919094974175096,50.54385202936828,17.44],[-4.920679992064834,50.54416601546109,11.67],[-4.921375019475818,50.54431797936559,7.35],[-4.921516003087163,50.54432401433587,7.83],[-4.921646006405354,50.54432803764939,9.27],[-4.922688966616988,50.54434899240732,13.6],[-4.923872994259,50.544399032369256,13.12],[-4.923978019505739,50.54442702792585,14.56],[-4.924040967598557,50.54447798989713,15.52],[-4.924090001732111,50.54451696574688,15.04],[-4.924146998673677,50.54456298239529,15.52],[-4.924209024757147,50.544612016528845,15.52],[-4.925016034394503,50.54502901621163,16.96],[-4.925115024670959,50.54507100954652,14.08],[-4.921552967280149,50.54432502016425,13.12],[-4.921277035027742,50.54429702460766,13.12],[-4.921137979254127,50.544266011565924,13.6],[-4.919568970799446,50.543926041573286,14.56],[-4.919407032430172,50.5439009796828,14.08],[-4.918550988659263,50.54383099079132,17.44],[-4.918387960642576,50.5438269674778,17.92],[-4.918214036151767,50.54384498856962,17.92],[-4.917841963469982,50.543882036581635,19.36],[-4.916377980262041,50.544182024896145,25.61],[-5.041291974484921,50.21830301731825,40.51],[-5.040013985708356,50.218421034514904,40.51],[-5.037447027862072,50.218275021761656,39.55],[-5.036173984408379,50.21807896904647,39.55],[-5.036023026332259,50.2180190384388,39.55],[-5.034516965970397,50.217415960505605,39.07],[-5.033773994073272,50.21723197773099,38.59],[-5.033655976876616,50.217219991609454,38.59],[-5.033574001863599,50.217223009094596,38.59],[-5.031930981203914,50.21723398938775,38.11],[-5.031781028956175,50.217218985781074,38.11],[-5.031034033745527,50.21705897524953,31.38],[-5.030374964699149,50.216862000525,29.94],[-5.030374964699149,50.216862000525,29.94],[-5.030374964699149,50.216862000525,29.94],[-5.030374964699149,50.216862000525,29.94],[-5.030114036053419,50.21679704077542,29.94],[-5.029936004430056,50.216789999976754,29.94],[-5.029799966141582,50.216789999976754,29.94],[-5.029712039977312,50.216789999976754,29.94],[-5.029669962823391,50.21679796278477,29.94],[-5.02962302416563,50.216811960563064,29.94],[-5.029610032215714,50.216815983876586,29.94],[-5.029198983684182,50.21690399385989,28.02],[-5.028733033686876,50.2169690374285,27.53],[-5.028602024540305,50.21680198609829,27.05],[-5.028661033138633,50.21645799279213,26.57],[-5.028518959879875,50.216466039419174,26.57],[-5.028536980971694,50.216336036100984,26.09],[-5.028849961236119,50.2162279933691,26.09],[-5.028883991762996,50.21618398837745,25.61],[-5.028745019808412,50.216084998100996,25.61],[-5.028234981000423,50.216062031686306,25.13],[-5.027996012941003,50.21602800115943,24.65],[-5.027996012941003,50.21602297201753,24.65],[-5.027986960485578,50.21602297201753,24.65],[-5.027983020991087,50.21602297201753,24.65],[-5.027973968535662,50.216019032523036,24.65],[-5.027964999899268,50.216016015037894,24.65],[-5.027952007949352,50.21601199172437,24.65],[-5.027553029358387,50.21591995842755,24.65],[-5.027192020788789,50.21577796898782,23.69],[-4.648126987740397,50.341275008395314,34.74],[-4.648136040195823,50.341385984793305,35.23],[-4.648125981912017,50.34147399477661,35.23],[-4.648123970255256,50.34156200475991,37.15],[-4.648093041032553,50.34162595868111,38.59],[-4.648022968322039,50.34167499281466,39.55],[-4.647925989702344,50.34169603139162,38.59],[-4.647826999425888,50.341708017513156,35.71],[-4.647719962522388,50.34171396866441,36.19],[-4.647602029144764,50.341726960614324,37.15],[-4.647474037483335,50.34174598753452,38.11],[-4.647112023085356,50.341816982254386,36.19],[-4.647001968696713,50.34182301722467,36.19],[-4.646888980641961,50.34180499613285,35.71],[-4.646769035607576,50.34178798086941,35.71],[-4.646655963733792,50.341750010848045,36.67],[-4.646228989586234,50.34161397255957,34.74],[-4.646080965176225,50.34158203750849,34.26],[-3.492452977225184,50.54923798888922,22.25],[-3.492481978610158,50.550523018464446,30.42],[-3.49212097004056,50.552131002768874,42.92],[-3.491844031959772,50.55347403511405,53.01],[-3.491655020043254,50.55412296205759,59.26],[-3.491607997566462,50.55417099036276,61.18],[-3.491193009540439,50.55470500141382,65.99],[-3.490485996007919,50.555658023804426,78.97],[-3.490335959941149,50.55579699575901,79.93],[-3.488924028351903,50.55688597261906,97.71],[-3.487614020705223,50.55791602469981,105.88],[-3.485741000622511,50.55905596353114,91.46],[-3.484119018539786,50.55946902371943,86.18],[-3.482896015048027,50.55960698984563,82.33],[-3.481220975518227,50.559999011456966,75.6],[-3.479215018451214,50.560682974755764,65.03],[-3.477842984721065,50.5612179916352,59.26],[-3.477702001109719,50.56132100522518,57.82],[-3.477578032761812,50.561433993279934,55.89],[-3.477464038878679,50.56155703961849,53.97],[-3.477362031117082,50.561696011573076,53.01],[-3.477303022518754,50.56182702071965,50.61],[-3.477253988385201,50.56195601820946,47.24],[-3.476965986192226,50.563561990857124,37.63],[-3.476583017036319,50.56503100320697,45.8],[-3.476229971274734,50.566291976720095,56.86],[-3.47568497993052,50.567557979375124,46.76],[-3.474853998050094,50.56857403367758,44.36],[-3.474157964810729,50.56940903887153,53.49],[-3.473137971013784,50.57091400958598,53.01],[-3.472670009359717,50.57218596339226,55.89],[-3.472362980246544,50.57339203543961,52.05],[-3.47157902084291,50.57437900453806,50.13],[-3.471447005867958,50.57446802034974,51.09],[-3.469943040981889,50.57516296394169,54.45],[-3.469826029613614,50.575229013338685,54.93],[-3.4690220374614,50.57591297663748,50.61],[-3.468229025602341,50.57670699432492,37.15],[-3.468186026439071,50.57678402401507,36.67],[-3.468145960941911,50.576862981542945,36.67],[-3.468126012012362,50.57695501483977,35.71],[-3.468133974820375,50.577052999287844,34.74],[-3.462422965094447,50.58245999738574,23.21],[-3.461892977356911,50.582985039800406,27.05],[-3.461865987628698,50.58304597623646,27.05]]},
                "properties":{"name":"The Beautiful Way Round - Part 2","stroke":"#606060","stroke-opacity":1,"stroke-width":4}}]}
        ];
        
        var routeLayers = new L.featureGroup([])
            .on('layeradd', onRouteLayerAdd);

        var animatedMarker;
        function onRouteLayerAdd(e) { 
            if(e.target.getLayers().length === files.length)
            {
                // Add Routes to map
                e.target.addTo(map);
                map.fitBounds(e.target.getBounds());

                // Animation
                animatedMarker = L.animatedMarker(latLngs, {
                    distance: 2000,  // meters
                    interval: 100, // milliseconds
                    autoStart: false
                });

                // Controls
                var baseLayer = { 
                    "Terrain": stamenTerrainTiles,
                    "Streets": osmTiles
                };
                var overlay = {
//                    "Routes": routeLayers,
                    "Animation": animatedMarker
                };
                layerControl = L.control.layers(baseLayer, overlay, {collapsed: false}).addTo(map);

            }
        }

        var latLngs = [];
        for (i = 0, len = files.length; i < len; i++) { 
          var promise = $.getJSON(files[i]);
          promise.then(function(data) {

            var route = L.geoJson(data, {
                style: function (feature) {
                    return { color: feature.properties.stroke };
                },
                onEachFeature: function (feature, layer) {
                    latLngs = latLngs.concat(L.GeoJSON.coordsToLatLngs(feature.geometry.coordinates));
                }
            }).bindPopup(function (layer) {
                return layer.feature.properties.name;
            })
            routeLayers.addLayer(route);
          });

        }

        
    </script>
</body>
</html>
